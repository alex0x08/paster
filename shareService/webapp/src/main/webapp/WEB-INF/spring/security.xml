<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/security"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:context="http://www.springframework.org/schema/context"
             xmlns:beans="http://www.springframework.org/schema/beans"
             xmlns:p="http://www.springframework.org/schema/p"
             xsi:schemaLocation="http://www.springframework.org/schema/beans 
                                 http://www.springframework.org/schema/beans/spring-beans.xsd
                                 http://www.springframework.org/schema/context 
                                 http://www.springframework.org/schema/context/spring-context.xsd
                                 http://www.springframework.org/schema/security 
                                 http://www.springframework.org/schema/security/spring-security.xsd">

                             

    <global-method-security secured-annotations="enabled" jsr250-annotations="enabled"   />
   

    <http pattern="/images/*" security="none"/>
    <http pattern="/css/*" security="none"/>
    <http pattern="/main/login*" security="none" />
    <http pattern="/main/logoutSuccess*" security="none" />

 
   <http pattern="/login-basic/**"   >
        <intercept-url pattern="/**" access="ROLE_USER,ROLE_ADMIN,ROLE_MANAGER" />
        <http-basic />
        
        <session-management >
            <concurrency-control error-if-maximum-exceeded="false" max-sessions="1"/>
        </session-management>
        
        <logout logout-url="/act/doLogout" 
            logout-success-url="/main/login.html?exit" 
            delete-cookies="JSESSIONID"
            invalidate-session="true"  />
    </http>

        
    <http realm="Ubershare realm" auto-config="false" use-expressions="true" 
           disable-url-rewriting="true"
          entry-point-ref="authenticationEntryPoint" >
 
         <custom-filter position="REMEMBER_ME_FILTER"
                           ref="rememberMeFilter" />
        <custom-filter position="FORM_LOGIN_FILTER"
                           ref="ssoAuthenticationProcessingFilter" />
 
        <intercept-url pattern="/main/*" access="permitAll()"/>
        <intercept-url pattern="/act/*" access="permitAll()"/>
        
        <intercept-url pattern="/**" access="permitAll()" />

       
        <!--form-login login-page="/main/login.html" 
        default-target-url='/main/index.html'
            always-use-default-target='true'
                    login-processing-url="/j_security_check"/-->
        
      
        <logout logout-url="/act/doLogout" 
        
        delete-cookies="JSESSIONID" success-handler-ref="ssoLogoutHandler"
            invalidate-session="true"  />
        <session-management >
            <concurrency-control error-if-maximum-exceeded="false" max-sessions="10"/>
        </session-management>
            
            
    </http>

     <beans:bean id="rememberMeFilter"
                class="org.springframework.security.web.authentication.rememberme.RememberMeAuthenticationFilter">
        <!-- custom-filter position="REMEMBER_ME_FILTER"/ -->
        <beans:property name="authenticationManager" ref="embedded-auth-manager" />
        <beans:property name="rememberMeServices" ref="ssoRememberMeServices" />
    </beans:bean>

    <beans:bean id="authenticationEntryPoint"
                class="org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint">
        <beans:property name="loginFormUrl" value="/main/login" />
    </beans:bean>

    <beans:bean id="ssoAuthenticationProcessingFilter"
                class="uber.megashare.service.security.UserAuthProcessingFilter">
        <beans:property name="authenticationManager" ref="embedded-auth-manager" />
        <beans:property name="userManager" ref="userManager" />

        <beans:property name="authenticationSuccessHandler">
            <beans:bean id="authenticationSuccessHandler"
                        class="uber.megashare.service.security.UserAuthSuccessHandler"
                        p:alwaysUseDefaultTargetUrl="false" p:defaultTargetUrl="/main/file/list" />
        </beans:property>
        <beans:property name="authenticationFailureHandler">
            <beans:bean id="authenticationFailureHandler"
                        class="org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler"
                        p:defaultFailureUrl="/main/login?authfailed=true" />
        </beans:property>
    </beans:bean>

    <beans:bean id="ssoLogoutHandler"
                class="uber.megashare.service.security.UserLogoutSuccessHandler">
        <beans:property name="userManager" ref="userManager" />

    </beans:bean>


    

    <authentication-manager  alias="embedded-auth-manager">
        <authentication-provider user-service-ref="userManager">
            <password-encoder ref="passwordEncoder"/>
        </authentication-provider>
         <authentication-provider ref="rememberMeAuthenticationProvider" />
    </authentication-manager>

    <!-- Override the default password-encoder (SHA) by uncommenting the following and changing the class -->
    <beans:bean id="passwordEncoder" class="org.springframework.security.authentication.encoding.ShaPasswordEncoder"/>

    <!-- Automatically receives AuthenticationEvent messages -->
    <beans:bean id="loggerListener" class="org.springframework.security.authentication.event.LoggerListener"/>

    <beans:bean id="rememberMeAuthenticationProvider"
                class="org.springframework.security.authentication.RememberMeAuthenticationProvider">
        <!-- This ensures that remember-me is added as an authentication provider -->
        <beans:property name="key" value="1q2w3e4r5t6y7u8i" />

    </beans:bean>

    <beans:bean id="ssoRememberMeServices"
                class="uber.megashare.service.security.UserRememberMeService">
        <beans:property name="userDetailsService" ref="userManager" />
        <beans:property name="cookieName" value="#{userManager.SSOCookieName}" />
        <beans:property name="key" value="1q2w3e4r5t6y7u8i" />

    </beans:bean>

    
</beans:beans>
